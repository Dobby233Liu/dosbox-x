name: Build for Linux & DOS (LOADLIN)

on:
  push:
  pull_request:
  release:
    types: [published]
    
jobs:
  linux_ubuntu:
    name: Build on Ubuntu
    
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ["", -sdl2]
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      
      - name: Install dependencies
        run: sudo apt install automake gcc g++ make libncurses-dev nasm libsdl-net1.2-dev libsdl2-net-dev libpcap-dev libslirp-dev fluidsynth libfluidsynth-dev libavdevice58 libavformat-dev libavcodec-dev libavcodec-extra libavcodec-extra58 libswscale-dev libfreetype-dev libxkbfile-dev libxrandr-dev
      
      # TODO: tests?
      # also i wonder why the debug variant is preferred?
      - name: Build & Install
        env:
          RUN_NSUFF: ${{ matrix.variant }}
        run: |
          chmod +x build-debug$RUN_NSUFF
          ./build-debug$RUN_NSUFF
          sudo make install
  
  build_rpm:
    name: Build RPM on Fedora
    #if: github.event_name == 'release'
    
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ["", -sdl2]
    container: fedora:latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
        
      - name: Install dependencies
        run: |
          sudo dnf group install "C Development Tools and Libraries" -y
          sudo dnf install -y SDL_net-devel SDL2_net-devel libxkbfile-devel ncurses-devel libpcap-devel libslirp-devel libpng-devel fluidsynth-devel freetype-devel nasm
          sudo dnf group install "RPM Development Tools" -y
          
      # TODO: tests?
      # also i wonder why the debug variant is preferred?
      - name: Build & Install
        env:
          RUN_NSUFF: ${{ matrix.variant }}
        run: |
          chmod +x build-debug$RUN_NSUFF
          ./build-debug$RUN_NSUFF
          sudo make install
      - name: Build RPM
        run: |
          ln -s /home ~
          mkdir -p ~/rpmbuild/SOURCES/
          ./make-rpm.sh
        
      # TODO upload and release
      
  # TODO: make LOADLIN package in this too
